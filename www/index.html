<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <title>予定表</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">オフライン</div>
    <div class="connection-status connecting" id="connectionStatus">接続中...</div>
    <div class="sync-status syncing" id="syncStatus">同期中</div>
    <div class="loading-indicator" id="loadingIndicator">データ読み込み中...</div>
    <div class="read-counter" id="readCounter">📊 読み取り: 0回</div>
    
    <!-- 繰り返し予定保存用のオーバーレイ -->
    <div class="repeat-save-overlay" id="repeatSaveOverlay">
        <div class="repeat-save-spinner-container">
            <div class="repeat-save-spinner"></div>
            <div class="repeat-save-text" id="repeatSaveText">保存中...</div>
        </div>
    </div>
    
    <div class="app">
        <header class="header">
            <div class="nav">
                <div class="week-controls-wrapper">
                    <div class="week-controls">
                        <button class="week-btn" id="prevWeekBtn" onclick="changeWeek(-1)">‹</button>
                        <span class="week-display" id="weekDisplay" onclick="openCalendarModal()"></span>
                        <button class="week-btn" id="nextWeekBtn" onclick="changeWeek(1)">›</button>
                    </div>
                    <span class="cache-status-below" id="cacheStatus">キャッシュ: 0週</span>
                </div>
                <button class="btn" onclick="goToToday()">今日</button>
                <button class="btn" id="bulkMenuBtn" onclick="toggleBulkMenu()">一括</button>
                <button class="btn" onclick="openSearchSidebar()">検索</button>
                <button class="btn" onclick="openHistorySidebar()">履歴</button>
                <button class="btn" id="reconnectBtn" onclick="if(app) app.manualReconnect()" style="display:none;background:#ff9800;color:white;">🔄 再接続</button>
                
                <!-- 一括メニュー（初期状態は非表示） -->
                <div id="bulkMenuButtons" style="display:none;">
                    <button class="btn" id="bulkReservationBtn" onclick="toggleBulkReservationMode()">一括予約</button>
                    <button class="btn primary" id="bulkProceedBtn" onclick="proceedToBulkReservation()" style="display:none">予約へ進む (<span id="bulkSelectionCount">0</span>件)</button>
                    <button class="btn" id="bulkDeleteBtn" onclick="toggleBulkDeleteMode()">一括削除</button>
                    <button class="btn danger" id="bulkDeleteExecuteBtn" onclick="executeBulkDelete()" style="display:none">削除する (<span id="bulkDeleteCount">0</span>件)</button>
                </div>
            </div>
            <div class="nav">
                <button class="btn" onclick="openManagement()">管理</button>
            </div>
            <div class="mobile-nav">
                <div class="mobile-buttons">
                    <div class="mobile-left">
                        <button class="week-btn" id="prevWeekBtnMobile" onclick="changeWeek(-1)">‹</button>
                        <span class="week-display" id="weekDisplayMobile" onclick="openCalendarModal()"></span>
                        <button class="week-btn" onclick="changeWeek(1)">›</button>
                    </div>
                    <div class="mobile-right">
                        <button class="btn" onclick="goToToday()">今日</button>
                        <button class="btn" id="bulkMenuBtnMobile" onclick="toggleBulkMenu()">一括</button>
                        <button class="btn" onclick="openSearchSidebar()">検索</button>
                        <button class="btn" onclick="openHistorySidebar()">履歴</button>
                        <button class="btn" id="reconnectBtnMobile" onclick="if(app) app.manualReconnect()" style="display:none;background:#ff9800;color:white;font-size:20px;padding:4px 8px;">🔄</button>
                        <span class="cache-status" id="cacheStatusMobile">キャッシュ: 0週</span>
                    </div>
                </div>
                <!-- モバイル用一括メニュー -->
                <div id="bulkMenuButtonsMobile" style="display:none;margin-top:8px;">
                    <button class="btn" id="bulkReservationBtnMobile" onclick="toggleBulkReservationMode()">一括予約</button>
                    <button class="btn primary" id="bulkProceedBtnMobile" onclick="proceedToBulkReservation()" style="display:none">予約へ進む (<span id="bulkSelectionCountMobile">0</span>件)</button>
                    <button class="btn" id="bulkDeleteBtnMobile" onclick="toggleBulkDeleteMode()">一括削除</button>
                    <button class="btn danger" id="bulkDeleteExecuteBtnMobile" onclick="executeBulkDelete()" style="display:none">削除する (<span id="bulkDeleteCountMobile">0</span>件)</button>
                </div>
            </div>
        </header>
        <main class="main">
            <div class="table-container" id="tableContainer">
                <table class="table" id="mainTable">
                    <tbody>
                        <tr>
                            <td class="loading-table" colspan="100%">スケジュールを読み込んでいます...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>

    </div>

    <!-- 検索サイドバー -->
    <div id="searchOverlay" class="search-overlay"></div>
    <div id="searchSidebar" class="search-sidebar">
        <div class="search-sidebar-header">
            <h2 style="margin:0;font-size:20px;font-weight:600;color:#333">🔍 予定検索</h2>
            <button onclick="closeSearchSidebar()" style="background:none;border:none;font-size:28px;cursor:pointer;color:#666;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center">&times;</button>
        </div>
        
        <div class="search-sidebar-content">
            <div style="margin-bottom:20px">
                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;font-size:14px">名前で検索:</label>
                <input type="text" id="sidebarSearchInput" placeholder="姓または名を入力" 
                       style="width:100%;padding:12px;font-size:16px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box">
                <button onclick="searchBySidebar()" 
                        style="width:100%;margin-top:10px;padding:12px;background:#4285f4;color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.2s"
                        onmouseover="this.style.background='#3367d6'"
                        onmouseout="this.style.background='#4285f4'">
                    🔍 検索
                </button>
            </div>
            
            <div id="sidebarSearchResults" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:2px solid #e0e0e0">
                    <h3 style="margin:0;font-size:16px;font-weight:600;color:#333">
                        検索結果: <span id="sidebarSearchResultCount" style="color:#4285f4">0</span>件
                    </h3>
                </div>
                <div id="sidebarSearchResultList"></div>
            </div>
        </div>
    </div>

    <!-- カレンダーモーダル -->
    <div id="calendarModal" class="modal calendar-modal">
        <div class="modal-content calendar-content">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="changeCalendarMonth(-1)">‹</button>
                <span id="calendarTitle"></span>
                <button class="calendar-nav" onclick="changeCalendarMonth(1)">›</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="modal-actions">
                <button class="action-btn secondary" onclick="closeCalendarModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 管理モーダル -->
    <div id="managementModal" class="modal">
        <div class="modal-content" style="max-width:700px">
            <span class="close" onclick="closeManagement()">&times;</span>
            <h2 class="modal-header">管理画面</h2>
            
            <div class="form-section">
                <label class="form-label">データ使用状況:</label>
                <div style="background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <div>
                            <div style="font-size:14px;color:#666;margin-bottom:5px">今日の読み取り</div>
                            <div style="font-size:18px;font-weight:bold;margin-bottom:3px" id="managementReadCount">0回 (この端末)</div>
                            <div style="font-size:22px;font-weight:bold;color:#2196f3" id="managementTotalCount">0回</div>
                            <div style="font-size:12px;color:#666">全端末合計</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:12px;color:#666">無料枠: 50,000回/日</div>
                            <div style="font-size:14px;font-weight:bold" id="managementRemaining">残り: 50,000回</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="action-btn primary" onclick="refreshTotalCount()" style="flex:1">🔄 最新の合計を取得</button>
                        <button class="action-btn primary" onclick="openFirebaseConsole()" style="flex:1">Firebase Consoleで確認</button>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <label class="form-label">データ出力:</label>
                <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px">
                    <button class="action-btn primary" onclick="exportPDF()">PDF出力</button>
                    <button class="action-btn primary" onclick="exportExcel()">Excel出力</button>
                </div>
            </div>
            
            <!-- 各管理機能へのボタン -->
            <div class="form-section">
                <label class="form-label">各種管理:</label>
                <div style="display:flex;flex-direction:column;gap:10px">
                    <button class="action-btn primary" onclick="openStaffManagement()" style="width:100%;padding:15px;font-size:16px">
                        👥 スタッフ管理を開く
                    </button>
                    <button class="action-btn primary" onclick="openLeaveManagement()" style="width:100%;padding:15px;font-size:16px">
                        📅 有給・公休日管理を開く
                    </button>
                    <button class="action-btn primary" onclick="openOverrideManagement()" style="width:100%;padding:15px;font-size:16px">
                        🔄 スタッフ入れ替え管理を開く
                    </button>
                    <button class="action-btn primary" onclick="openDayScheduleManagement()" style="width:100%;padding:15px;font-size:16px">
                        📊 デイスケジュール管理を開く
                    </button>
                    <button class="action-btn primary" onclick="openHolidayManagement()" style="width:100%;padding:15px;font-size:16px">
                        🎌 祝日管理を開く
                    </button>
                    <!-- ⭐ 重複予定チェック機能 -->
                    <button class="action-btn" onclick="findDuplicatesFromCache()" style="width:100%;padding:15px;font-size:16px;background:#f44336;color:white">
                        ⚠️ 重複予定をチェック
                    </button>
                </div>
            </div>
            
            <!-- ⭐ データ管理セクション（バックアップ＆復元） -->
            <div class="form-section" style="margin-top:30px;padding-top:20px;border-top:2px solid #eee">
                <label class="form-label">💾 データ管理:</label>
                <p style="font-size:13px;color:#666;margin:10px 0">全データのバックアップ作成と復元ができます</p>
                <div style="display:flex;flex-direction:column;gap:10px">
                    <button class="action-btn primary" onclick="createBackup()" style="width:100%;padding:15px;font-size:16px;background:linear-gradient(135deg, #4285f4, #34a853);color:white">
                        💾 バックアップを作成
                    </button>
                    <button class="action-btn" onclick="openRestoreModal()" style="width:100%;padding:15px;font-size:16px;background:linear-gradient(135deg, #ff9800, #f57c00);color:white">
                        📥 バックアップから復元
                    </button>
                </div>
            </div>
            
            <!-- 削除できない予定の管理セクション -->
            <div class="form-section">
                <label class="form-label" style="color:#d32f2f">⚠️ 削除できない予定の管理:</label>
                <p style="font-size:13px;color:#666;margin:10px 0">通常の方法で削除できない予定を検索して削除できます</p>
                
                <div style="display:flex;flex-direction:column;gap:12px;margin-top:15px">
                    <!-- 検索条件 -->
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <select id="troubleDeleteStaff" class="form-select" style="min-width:100px">
                            <option value="">スタッフ</option>
                            <option value="Ka">Ka</option>
                            <option value="I">I</option>
                            <option value="Kik">Kik</option>
                            <option value="J">J</option>
                            <option value="Sim">Sim</option>
                            <option value="Yo">Yo</option>
                            <option value="Sai">Sai</option>
                            <option value="Ta">Ta</option>
                        </select>
                        <input type="date" id="troubleDeleteDate" class="form-input" style="min-width:150px">
                        <input type="text" id="troubleDeleteName" class="form-input" placeholder="名前（任意）" style="min-width:120px">
                        <button class="action-btn primary" onclick="searchTroubleEvents()" style="white-space:nowrap">検索</button>
                    </div>
                    
                    <!-- 検索結果 -->
                    <div id="troubleEventResults" style="display:none">
                        <div style="background:#f5f5f5;border-radius:8px;padding:15px;max-height:300px;overflow-y:auto">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                <strong id="troubleResultCount" style="font-size:14px">検索結果: 0件</strong>
                                <button class="action-btn danger" onclick="deleteAllTroubleEvents()" id="deleteAllBtn" style="display:none">すべて削除</button>
                            </div>
                            <div id="troubleEventList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- スタッフ管理モーダル -->
    <div id="staffManagementModal" class="modal">
        <div class="modal-content" style="max-width:700px">
            <span class="close" onclick="closeStaffManagement()">&times;</span>
            <h2 class="modal-header">👥 スタッフ管理</h2>
            
            <div class="form-section">
                <label class="form-label">スタッフ一覧:</label>
                <div id="staffList" class="list"></div>
            </div>
            
            <div class="form-section">
                <label class="form-label">新しいスタッフを追加:</label>
                <div style="display:flex;gap:10px">
                    <input type="text" id="newStaffSurname" class="form-input" placeholder="姓" style="flex:1" lang="ja" inputmode="text" autocomplete="off">
                    <input type="text" id="newStaffFirstname" class="form-input" placeholder="名" style="flex:1" lang="ja" inputmode="text" autocomplete="off">
                    <button class="action-btn primary" onclick="addStaff()">追加</button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="action-btn secondary" onclick="closeStaffManagement()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 有給・公休日管理モーダル -->
    <div id="leaveManagementModal" class="modal">
        <div class="modal-content" style="max-width:700px">
            <span class="close" onclick="closeLeaveManagement()">&times;</span>
            <h2 class="modal-header">📅 有給・公休日管理</h2>
            
            <div class="form-section">
                <label class="form-label">有給・公休日一覧:</label>
                <div id="staffLeaveList" class="list"></div>
            </div>
            
            <div class="form-section">
                <label class="form-label">有給・公休日の追加:</label>
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:100px;font-weight:600;font-size:14px">スタッフ:</label>
                        <select id="leaveStaffSelect" class="form-select" style="flex:1">
                            <option value="">スタッフを選択</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:100px;font-weight:600;font-size:14px">日付:</label>
                        <input type="date" id="leaveDate" class="form-input" style="flex:1">
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:100px;font-weight:600;font-size:14px">開始時間:</label>
                        <select id="leaveStartTime" class="form-select" style="flex:1">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:100px;font-weight:600;font-size:14px">終了時間:</label>
                        <select id="leaveEndTime" class="form-select" style="flex:1">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div style="display:flex;justify-content:flex-end">
                        <button class="action-btn primary" onclick="addStaffLeave()">追加</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="action-btn secondary" onclick="closeLeaveManagement()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- スタッフ入れ替え管理モーダル -->
    <div id="overrideManagementModal" class="modal">
        <div class="modal-content" style="max-width:700px">
            <span class="close" onclick="closeOverrideManagement()">&times;</span>
            <h2 class="modal-header">🔄 スタッフ入れ替え管理</h2>
            
            <div class="form-section">
                <label class="form-label">スタッフ入れ替え一覧:</label>
                <div id="staffOverrideList" class="list"></div>
            </div>
            
            <div class="form-section">
                <label class="form-label">新しいスタッフ入れ替えを追加:</label>
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:100px;font-weight:600;font-size:14px">日付:</label>
                        <input type="date" id="overrideDate" class="form-input" style="flex:1">
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:100px;font-weight:600;font-size:14px">休みにする:</label>
                        <select id="overrideOriginalStaff" class="form-select" style="flex:1">
                            <option value="">スタッフを選択</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:100px;font-weight:600;font-size:14px">代わりに出勤:</label>
                        <select id="overrideReplacementStaff" class="form-select" style="flex:1">
                            <option value="">スタッフを選択</option>
                        </select>
                    </div>
                    <div style="display:flex;justify-content:flex-end">
                        <button class="action-btn primary" onclick="addStaffOverride()">追加</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="action-btn secondary" onclick="closeOverrideManagement()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- デイスケジュール管理モーダル -->
    <div id="dayScheduleManagementModal" class="modal">
        <div class="modal-content" style="max-width:700px">
            <span class="close" onclick="closeDayScheduleManagement()">&times;</span>
            <h2 class="modal-header">📊 デイスケジュール管理</h2>
            
            <div class="form-section">
                <label class="form-label">デイスケジュール一覧:</label>
                <div id="dayScheduleList" class="list"></div>
            </div>
            
            <div class="form-section">
                <label class="form-label">新しいデイ設定を追加:</label>
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:80px;font-weight:600;font-size:14px">スタッフ:</label>
                        <select id="dayScheduleStaffSelect" class="form-select" style="flex:1">
                            <option value="">スタッフを選択</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:80px;font-weight:600;font-size:14px">曜日:</label>
                        <div id="dayScheduleDaysSection" style="display:flex;gap:8px;flex-wrap:wrap">
                            <label class="workday-checkbox">
                                <input type="checkbox" value="1">
                                <span class="checkmark"></span>
                                <span class="day-label">月</span>
                            </label>
                            <label class="workday-checkbox">
                                <input type="checkbox" value="2">
                                <span class="checkmark"></span>
                                <span class="day-label">火</span>
                            </label>
                            <label class="workday-checkbox">
                                <input type="checkbox" value="3">
                                <span class="checkmark"></span>
                                <span class="day-label">水</span>
                            </label>
                            <label class="workday-checkbox">
                                <input type="checkbox" value="4">
                                <span class="checkmark"></span>
                                <span class="day-label">木</span>
                            </label>
                            <label class="workday-checkbox">
                                <input type="checkbox" value="5">
                                <span class="checkmark"></span>
                                <span class="day-label">金</span>
                            </label>
                            <label class="workday-checkbox">
                                <input type="checkbox" value="6">
                                <span class="checkmark"></span>
                                <span class="day-label">土</span>
                            </label>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="min-width:80px;font-weight:600;font-size:14px">パターン:</label>
                        <select id="daySchedulePattern" class="form-select" style="flex:1">
                            <option value="pattern1">パターン① 9:20-14:40</option>
                            <option value="pattern2">パターン② 13:00-14:40</option>
                            <option value="custom">カスタム（時間指定）</option>
                        </select>
                    </div>
                    <div id="customTimeSection" style="display:none;gap:10px;align-items:center">
                        <label style="min-width:80px;font-weight:600;font-size:14px">時間範囲:</label>
                        <div style="flex:1;display:flex;gap:10px;align-items:center">
                            <select id="dayScheduleStartTime" class="form-select" style="flex:1">
                                <option value="">開始時間</option>
                                <option value="09:00">9:00</option>
                                <option value="09:20">9:20</option>
                                <option value="09:40">9:40</option>
                                <option value="10:00">10:00</option>
                                <option value="10:20">10:20</option>
                                <option value="10:40">10:40</option>
                                <option value="11:00">11:00</option>
                                <option value="11:20">11:20</option>
                                <option value="11:40">11:40</option>
                                <option value="12:00">12:00</option>
                                <option value="12:20">12:20</option>
                                <option value="12:40">12:40</option>
                                <option value="13:00">13:00</option>
                                <option value="13:20">13:20</option>
                                <option value="13:40">13:40</option>
                                <option value="14:00">14:00</option>
                                <option value="14:20">14:20</option>
                                <option value="14:40">14:40</option>
                                <option value="15:00">15:00</option>
                            </select>
                            <span>〜</span>
                            <select id="dayScheduleEndTime" class="form-select" style="flex:1">
                                <option value="">終了時間</option>
                                <option value="09:00">9:00</option>
                                <option value="09:20">9:20</option>
                                <option value="09:40">9:40</option>
                                <option value="10:00">10:00</option>
                                <option value="10:20">10:20</option>
                                <option value="10:40">10:40</option>
                                <option value="11:00">11:00</option>
                                <option value="11:20">11:20</option>
                                <option value="11:40">11:40</option>
                                <option value="12:00">12:00</option>
                                <option value="12:20">12:20</option>
                                <option value="12:40">12:40</option>
                                <option value="13:00">13:00</option>
                                <option value="13:20">13:20</option>
                                <option value="13:40">13:40</option>
                                <option value="14:00">14:00</option>
                                <option value="14:20">14:20</option>
                                <option value="14:40">14:40</option>
                                <option value="15:00">15:00</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:flex-end">
                        <button class="action-btn primary" onclick="addDaySchedule()">追加</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="action-btn secondary" onclick="closeDayScheduleManagement()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 祝日管理モーダル -->
    <div id="holidayManagementModal" class="modal">
        <div class="modal-content" style="max-width:700px">
            <span class="close" onclick="closeHolidayManagement()">&times;</span>
            <h2 class="modal-header">🎌 祝日管理</h2>
            
            <div class="form-section">
                <label class="form-label">祝日一覧:</label>
                <div id="holidayList" class="list"></div>
            </div>
            
            <div class="form-section">
                <label class="form-label">祝日を一括取得:</label>
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
                    <select id="holidayYear" class="form-select" style="flex:1">
                        <option value="">年を選択</option>
                    </select>
                    <button class="action-btn primary" onclick="fetchHolidaysFromInternet()">📥 インターネットから取得</button>
                </div>
                <p style="font-size:12px;color:#666;margin:0">※内閣府の祝日データから自動取得します</p>
            </div>
            
            <div class="form-section">
                <label class="form-label">新しい祝日を手動追加:</label>
                <div style="display:flex;gap:10px">
                    <input type="date" id="newHolidayDate" class="form-input" style="flex:1">
                    <button class="action-btn primary" onclick="addHoliday()">追加</button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="action-btn secondary" onclick="closeHolidayManagement()">閉じる</button>
            </div>
        </div>
    </div>
    <!-- イベント編集モーダル -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEvent()">&times;</span>
            <h2 class="modal-header" id="modalHeader">予約追加</h2>
            <div class="selected-time" id="selectedTimeDisplay"></div>
            <div class="form-section" id="surnameSection">
                <label class="form-label">姓:</label>
                <input type="text" id="surnameInput" class="form-input" placeholder="姓を入力(必須)" required lang="ja" inputmode="text" autocomplete="off">
            </div>
            <div class="form-section" id="firstnameSection">
                <label class="form-label">名:</label>
                <input type="text" id="firstnameInput" class="form-input" placeholder="名を入力(任意)" lang="ja" inputmode="text" autocomplete="off">
            </div>
            <div class="form-section" id="timeRangeSection" style="display:none">
                <label class="form-label">時間範囲:</label>
                <div class="time-range-selects">
                    <div>
                        <label class="form-label" style="font-size:13px;margin-bottom:5px">開始時刻:</label>
                        <select id="startTimeSelect" class="form-select"></select>
                    </div>
                    <div>
                        <label class="form-label" style="font-size:13px;margin-bottom:5px">終了時刻:</label>
                        <select id="endTimeSelect" class="form-select"></select>
                    </div>
                </div>
            </div>
            <div class="form-section">
                <label class="form-label">予定種類:</label>
                <div class="type-grid">
                    <div class="type-option type-20min" data-type="20min">20分</div>
                    <div class="type-option type-40min" data-type="40min">40分</div>
                    <div class="type-option type-60min" data-type="60min">60分</div>
                    <div class="type-option type-visit" data-type="visit">訪問</div>
                    <div class="type-option type-workinjury20" data-type="workinjury20">労災20分</div>
                    <div class="type-option type-workinjury40" data-type="workinjury40">労災40分</div>
                    <div class="type-option type-accident" data-type="accident">事故</div>
                    <div class="type-option type-crutch" data-type="crutch">松葉杖指導</div>
                    <div class="type-option type-day" data-type="day">デイ</div>
                    <div class="type-option type-meeting" data-type="meeting">担会</div>
                    <div class="type-option type-other" data-type="other">その他</div>
                </div>
            </div>
            <div class="form-section" id="newPatientSection" style="display:none">
                <label class="form-label">新患:</label>
                <div style="display:flex;align-items:center;gap:10px">
                    <label class="toggle-switch">
                        <input type="checkbox" id="newPatientToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="newPatientLabel" style="font-size:14px;color:#666">既存患者</span>
                </div>
            </div>
            <div class="form-section" id="repeatSection">
                <label class="form-label">繰り返し:</label>
                <select id="repeatSelect" class="form-select">
                    <option value="none">なし</option>
                    <option value="weekly">毎週</option>
                    <option value="biweekly1">隔週(1週間おき)</option>
                    <option value="biweekly2">隔週(2週間おき)</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="action-btn danger" id="deleteButton" onclick="deleteEvent()" style="display:none">削除</button>
                <button class="action-btn danger" id="deleteSingleButton" onclick="deleteSingle()" style="display:none">この予定のみ削除</button>
                <button class="action-btn danger" id="deleteFromButton" onclick="deleteFrom()" style="display:none">この日以降を削除</button>
                <button class="action-btn secondary" onclick="closeEvent()">キャンセル</button>
                <button class="action-btn primary" id="saveEventBtn" onclick="saveEvent()">保存</button>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Firebase初期化を一度だけ実行
        if (!window.firebaseInitialized) {
            window.firebaseInitialized = true;
            
            firebase.initializeApp({
                apiKey: "AIzaSyCFj54m36M6Ai-3qPqCOUv-hzjtQf34YsU",
                authDomain: "schedule-manager-87b03.firebaseapp.com",
                projectId: "schedule-manager-87b03",
                storageBucket: "schedule-manager-87b03.firebasestorage.app",
                messagingSenderId: "280835955919",
                appId: "1:280835955919:web:69a1ec7c9e5c20cdc2ebba"
            });
            
            window.db = firebase.firestore();
            
            window.db.enablePersistence({
                synchronizeTabs: false
            }).catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.log('The current browser does not support persistence.');
                }
            });
        }
        
        var db = window.db;
        var isCapacitorApp = false;
        var CapacitorApp, StatusBar, SplashScreen, Network, Keyboard, Haptics, Toast, Dialog;
        var app;
    </script>
    
    <script src="app-core.js"></script>
    <script src="read-counter.js"></script>
    <script src="app-events.js"></script>
    <script src="conflict-check.js"></script>
    <script src="repeat-auto-generate.js"></script>
    <script src="improved-delete.js"></script>
    <script src="app-ui.js"></script>
    <script src="app-export.js"></script>
    <script src="app-main.js"></script>
    <script src="app-init.js"></script>
    <script src="trouble-delete.js"></script>
    <script src="bulk-reservation.js"></script>
    <script src="bulk-delete.js"></script>
    <script src="search-sidebar.js"></script><!-- ⭐ 検索機能（サイドバー版） -->
    <script src="audit-log.js"></script><!-- ⭐ 履歴記録機能 -->
    <script src="history-sidebar.js"></script><!-- ⭐ 履歴表示機能 -->
    <script src="holiday-fetch.js"></script>
    <script src="management-modals.js"></script>
    <script src="duplicate-detection-optimized.js"></script><!-- ⭐ 重複予定チェック機能（読み取り0回） -->
    <script src="backup-restore.js"></script><!-- ⭐ バックアップ＆復元機能 -->
    
   <!-- スタッフセレクトボックス動的更新用スクリプト -->
<script>
    window.addEventListener('load', function() {
        setTimeout(() => {
            const originalOpenManagement = window.openManagement;
            window.openManagement = function() {
                if (originalOpenManagement) originalOpenManagement();
                updateStaffSelects();
            };
            
            function updateStaffSelects() {
                setTimeout(() => {
                    if (window.app && window.app.teamMembers) {
                        // スタッフ入れ替え用
                        const select1 = document.getElementById('overrideOriginalStaff');
                        const select2 = document.getElementById('overrideReplacementStaff');
                        
                        // 有給・公休日用
                        const leaveSelect = document.getElementById('leaveStaffSelect');
                        
                        if (select1 && select2) {
                            const current1 = select1.value;
                            const current2 = select2.value;
                            
                            select1.innerHTML = '<option value="">スタッフを選択</option>';
                            select2.innerHTML = '<option value="">スタッフを選択</option>';
                            
                            window.app.teamMembers.forEach(m => {
                                const name = `${m.surname || ''}${m.firstname || ''}`;
                                
                                const option1 = document.createElement('option');
                                option1.value = name;
                                option1.textContent = name;
                                select1.appendChild(option1);
                                
                                const option2 = document.createElement('option');
                                option2.value = name;
                                option2.textContent = name;
                                select2.appendChild(option2);
                            });
                            
                            select1.value = current1;
                            select2.value = current2;
                        }
                        
                        if (leaveSelect) {
                            const currentLeave = leaveSelect.value;
                            
                            leaveSelect.innerHTML = '<option value="">スタッフを選択</option>';
                            
                            window.app.teamMembers.forEach(m => {
                                const name = `${m.surname || ''}${m.firstname || ''}`;
                                const option = document.createElement('option');
                                option.value = name;
                                option.textContent = name;
                                leaveSelect.appendChild(option);
                            });
                            
                            leaveSelect.value = currentLeave;
                        }
                    }
                }, 100);
            }
        }, 2000);
    });
    
    // デイスケジュールのパターン選択処理
    document.addEventListener('DOMContentLoaded', () => {
        const patternSelect = document.getElementById('daySchedulePattern');
        const customTimeSection = document.getElementById('customTimeSection');
        
        if (patternSelect) {
            patternSelect.addEventListener('change', () => {
                if (patternSelect.value === 'custom') {
                    customTimeSection.style.display = 'flex';
                } else {
                    customTimeSection.style.display = 'none';
                }
            });
        }
    });
</script>

<!-- 履歴サイドバー -->
<div id="historyOverlay" class="history-overlay"></div>
<div id="historySidebar" class="history-sidebar">
    <div class="history-sidebar-header">
        <h2 style="margin:0;font-size:20px;font-weight:600;color:#333">📋 操作履歴</h2>
        <button onclick="closeHistorySidebar()" 
                style="background:none;border:none;font-size:28px;cursor:pointer;color:#666;line-height:1;padding:0">
            ×
        </button>
    </div>
    
    <div class="history-sidebar-content">
        <!-- 結果表示（前面に移動） -->
        <div style="background:#e3f2fd;border-left:4px solid #2196f3;padding:12px;margin-bottom:15px;border-radius:4px;position:relative;z-index:1">
            <div style="font-size:13px;color:#1976d2">
                履歴: <span id="historyResultCount" style="font-weight:600;font-size:15px">0</span>件
            </div>
        </div>
        
        <!-- フィルター折りたたみボタン -->
        <button onclick="toggleHistoryFilters()" 
                class="action-btn secondary" 
                style="width:100%;margin-bottom:15px;padding:10px;display:flex;justify-content:space-between;align-items:center">
            <span>🔍 フィルター</span>
            <span id="filterToggleIcon">▼</span>
        </button>
        
        <!-- フィルター（初期状態は非表示） -->
        <div id="historyFiltersContainer" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px">
            <!-- 日付範囲 -->
            <div style="margin-bottom:12px">
                <label style="display:block;margin-bottom:6px;font-size:13px;color:#666">期間:</label>
                <select id="historyDateRange" 
                        style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
                    <option value="7">過去7日間</option>
                    <option value="30">過去30日間</option>
                    <option value="90">過去90日間</option>
                    <option value="all">全期間</option>
                </select>
            </div>
            
            <!-- メンバー -->
            <div style="margin-bottom:12px">
                <label style="display:block;margin-bottom:6px;font-size:13px;color:#666">担当:</label>
                <select id="historyMemberFilter" 
                        style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
                    <option value="all">すべて</option>
                    <!-- メンバーは動的に追加される -->
                </select>
            </div>
            
            <!-- アクション -->
            <div style="margin-bottom:12px">
                <label style="display:block;margin-bottom:6px;font-size:13px;color:#666">操作:</label>
                <select id="historyActionFilter" 
                        style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
                    <option value="all">すべて</option>
                    <option value="create">🆕 追加</option>
                    <option value="update">✏️ 変更</option>
                    <option value="delete">🗑️ 削除</option>
                </select>
            </div>
            
            <div style="display:flex;gap:8px">
                <button onclick="applyHistoryFilters()" 
                        class="action-btn primary" 
                        style="flex:1;padding:8px;font-size:13px">
                    適用
                </button>
                <button onclick="resetHistoryFilters()" 
                        class="action-btn secondary" 
                        style="flex:1;padding:8px;font-size:13px">
                    リセット
                </button>
            </div>
        </div>
        
        <!-- 履歴リスト -->
        <div id="historyLogsContainer">
            <div style="text-align:center;padding:40px;color:#999">
                📋 履歴を読み込んでいます...
            </div>
        </div>
        
        <!-- さらに読み込むボタン -->
        <button id="loadMoreHistoryBtn" 
                onclick="loadHistoryLogs(true)" 
                class="action-btn secondary" 
                style="width:100%;margin-top:10px;display:none">
            さらに読み込む
        </button>
    </div>
</div>

</body>
</html>
